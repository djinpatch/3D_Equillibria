<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Interactive 3D Scalars</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <!-- MathJax for LaTeX -->
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <style>
    :root { --maxw: 1100px; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Arial, sans-serif; color:#111; }
    header { max-width:var(--maxw); margin:16px auto 8px; padding:0 12px; }
    h1 { margin:0; font-size:20px; font-weight:700; }
    .controls { max-width:var(--maxw); margin:10px auto 6px; padding:0 12px;
                display:flex; gap:14px; align-items:center; flex-wrap:wrap; }

    /* Scalar "buttons" (radio pills) with LaTeX labels */
    .pills { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pills input[type="radio"] { display:none; }
    .pills label {
      cursor:pointer; padding:6px 12px; border:1px solid #cfd8e3;
      border-radius:999px; background:#fff; user-select:none;
    }
    .pills input[type="radio"]:checked + label {
      background:#e8f0fe; border-color:#7aa0ff;
    }

    /* Arrows toggle */
    .toggle { display:flex; align-items:center; gap:8px; }

    /* Title + status */
    #title { text-align:center; margin:8px auto 0; font-size:20px; font-weight:700; min-height:1.6em; }
    #status { text-align:center; margin:4px auto 8px; font-size:14px; color:#666; min-height:1.2em; }

    /* Viewer + legend */
    .frame { max-width:var(--maxw); margin:0 auto; border:2px solid #cfe3ff; border-radius:8px; }
    #viewerHost { width:100%; height:62vh; }
    .legend-wrap { max-width:var(--maxw); margin:10px auto 20px; text-align:center; padding:0 12px; }
    .legend { width:100%; max-width:900px; height:auto; display:block; margin:0 auto; }

    @media (max-width:800px){
      #viewerHost{ height:60vh; }
      .legend { max-width:95%; }
    }
  </style>
</head>
<body>
  <header><h1>Interactive 3D Scalars</h1></header>

  <div class="controls">
    <div class="pills" id="scalarPills" role="tablist" aria-label="Scalar selection">
      <!-- Default = kappa -->
      <input type="radio" name="scalar" id="s_kappa" value="kappa" checked>
      <label for="s_kappa">\( \kappa \)</label>

      <input type="radio" name="scalar" id="s_gradB" value="gradB">
      <label for="s_gradB">\( \nabla |B| \)</label>

      <input type="radio" name="scalar" id="s_jdia" value="jdia">
      <label for="s_jdia">\( J_{\mathrm{dia}} \)</label>
    </div>

    <div class="toggle">
      <input type="checkbox" id="arrows">
      <label for="arrows">\( \text{Arrows} \)</label>
    </div>
  </div>

  <div id="title">\( \kappa \)</div>
  <div id="status"></div>

  <div class="frame">
    <div id="viewerHost"></div>
  </div>

  <div class="legend-wrap">
    <img id="legend" class="legend" src="kappa_eq1_colorbar.png" alt="colorbar">
    <!-- no label below the colorbar per your request -->
  </div>

<script>
  // ------- filenames (must match repo exactly; case-sensitive) -------
  const MAP = {
    kappa: { base: "kappa_eq1.glb",  arrows: "kappa_q_eq1.glb",  legend: "kappa_eq1_colorbar.png",  latex: "\\( \\\\kappa \\\\)" },
    gradB: { base: "gradB_eq1.glb",  arrows: "gradB_q_eq1.glb",  legend: "gradB_eq1_colorbar.png", latex: "\\( \\\\nabla |B| \\\\)" },
    jdia:  { base: "jdia_eq1.glb",   arrows: "jdia_q_eq1.glb",   legend: "jdia_eq1_colorbar.png",   latex: "\\( J_{\\\\mathrm{dia}} \\\\)" }
  };

  // ------- elements + state -------
  const host      = document.getElementById('viewerHost');
  const titleEl   = document.getElementById('title');
  const statusEl  = document.getElementById('status');
  const legendImg = document.getElementById('legend');
  const pills     = document.getElementById('scalarPills');
  const arrowsEl  = document.getElementById('arrows');

  let scalar = 'kappa';
  let showArrows = false;
  let loadToken = 0;

  function setStatusLoading(on) {
    statusEl.textContent = on ? 'Loading…' : '';
  }

  function latexTitle(s) {
    titleEl.innerHTML = MAP[s].latex;
    if (window.MathJax?.typesetPromise) MathJax.typesetPromise([titleEl]);
  }

  function buildViewer() {
    const mv = document.createElement('model-viewer');
    mv.setAttribute('camera-controls', '');
    mv.setAttribute('auto-rotate', '');
    mv.setAttribute('exposure', '1.0');
    mv.setAttribute('shadow-intensity', '0.5');
    mv.setAttribute('bounds', 'tight');
    mv.setAttribute('environment-image', 'neutral');
    mv.setAttribute('interaction-prompt', 'none');
    mv.setAttribute('disable-backfaces', '');
    mv.setAttribute('disable-occlusion', '');
    mv.style.width = '100%';
    mv.style.height = '100%';
    mv.style.background = '#fff';
    mv.style.borderRadius = '8px';
    return mv;
  }

  async function loadModel(url) {
    const myToken = ++loadToken;
    setStatusLoading(true);

    // Fetch as bytes, do a light GLB header check, then feed a Blob URL
    try {
      const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now(), { cache: 'no-store' });
      const buf = await res.arrayBuffer();

      if (buf.byteLength < 12) throw new Error('tiny'); // minimal check, but we hide details per your request
      const dv = new DataView(buf, 0, 12);
      if (dv.getUint32(0, true) !== 0x46546C67) throw new Error('magic');

      // recreate the viewer each load
      host.innerHTML = '';
      const mv = buildViewer();
      host.appendChild(mv);

      const blob = new Blob([buf], { type: 'model/gltf-binary' });
      const objectURL = URL.createObjectURL(blob);

      mv.addEventListener('load', () => {
        if (myToken !== loadToken) return;
        setStatusLoading(false);
        // free later
        setTimeout(() => URL.revokeObjectURL(objectURL), 10000);
      }, { once:true });

      // no verbose error text—just stop showing "Loading…"
      mv.addEventListener('error', () => {
        if (myToken !== loadToken) return;
        setStatusLoading(false);
      }, { once:true });

      mv.src = objectURL;
    } catch {
      if (myToken !== loadToken) return;
      setStatusLoading(false);
    }
  }

  function update() {
    const files = MAP[scalar];
    latexTitle(scalar);
    legendImg.src = files.legend;
    loadModel(showArrows ? files.arrows : files.base);
  }

  // ------- events -------
  pills.addEventListener('change', (e) => {
    if (e.target && e.target.name === 'scalar') {
      scalar = e.target.value;
      update();
    }
  });
  arrowsEl.addEventListener('change', () => {
    showArrows = arrowsEl.checked;
    update();
  });

  // Initial render
  update();
</script>
</body>
</html>
