<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Interactive 3D Scalars</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root { --maxw: 1200px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Arial, sans-serif; color:#111; background:#fff;
           display:flex; flex-direction:column; align-items:center; }
    header { width:100%; max-width:var(--maxw); padding:16px 18px 6px; }
    header h1 { margin:0; font-size:1.6rem; }
    .controls { width:100%; max-width:var(--maxw); padding:6px 18px 0;
                display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; }
    main { width:100%; max-width:var(--maxw); padding:10px 18px 28px; }
    #viewerHost { width:100%; height:70vh; border:2px solid #cfe3ff; border-radius:8px; }
    #status { text-align:center; min-height:1.4em; margin:6px 0 2px; color:#666; }
    #status.ok { color:#2e7d32; }  /* green */
    #status.err { color:#b00020; } /* red */
    .legend-wrap { display:flex; flex-direction:column; align-items:center; margin:10px 0 6px; }
    .legend { width:100%; max-width:820px; height:auto; display:block; }
    .legend-label, .tiny { font-size:.95rem; color:#666; text-align:center; }
    .tiny a { color:#1a73e8; text-decoration:none; }
    .tiny a:hover { text-decoration:underline; }
    @media (max-width:800px){ #viewerHost{ height:60vh; } .legend{ max-width:95%; } }
  </style>
</head>
<body>
  <header><h1>Interactive 3D Scalars</h1></header>

  <div class="controls">
    <label for="scalar">Scalar:</label>
    <select id="scalar">
      <option value="kappa">kappa</option>
      <option value="gradB">gradB</option>
      <option value="jdia">jdia</option>
    </select>
    <button id="toggle-arrows" type="button">Show arrows</button>
  </div>

  <main>
    <h2 id="title" style="text-align:center;margin:8px 0 6px;">kappa</h2>
    <div id="status"></div>

    <!-- We recreate the <model-viewer> inside this host on every switch -->
    <div id="viewerHost"></div>

    <p class="tiny">Current model URL: <a id="currentLink" href="#" target="_blank" rel="noopener">—</a></p>

    <div class="legend-wrap">
      <img id="legend" class="legend" src="kappa_eq1_colorbar.png" alt="kappa colorbar">
      <div id="legend-label" class="legend-label">kappa</div>
    </div>
  </main>

  <script>
    // Exact filenames on disk
    const MODELS = {
      kappa: { base: "kappa_eq1.glb",  arrows: "kappa_q_eq1.glb",  legend: "kappa_eq1_colorbar.png",  label: "kappa" },
      gradB: { base: "gradB_eq1.glb",  arrows: "gradB_q_eq1.glb",  legend: "gradB_eq1_colorbar.png",  label: "gradB" },
      jdia:  { base: "jdia_eq1.glb",   arrows: "jdia_q_eq1.glb",   legend: "jdia_eq1_colorbar.png",   label: "jdia" }
    };

    // UI handles
    const host        = document.getElementById("viewerHost");
    const statusEl    = document.getElementById("status");
    const legendImg   = document.getElementById("legend");
    const legendLabel = document.getElementById("legend-label");
    const selScalar   = document.getElementById("scalar");
    const btnArrows   = document.getElementById("toggle-arrows");
    const title       = document.getElementById("title");
    const linkEl      = document.getElementById("currentLink");

    // State
    let scalar = selScalar.value;   // "kappa" initially
    let arrows = false;             // start with scalar surface only
    let loadToken = 0;              // cancel stale loads

    // Helpers
    function setStatus(text, cls="") {
      statusEl.className = cls;
      statusEl.textContent = text || "";
    }

    function buildViewer() {
      const mv = document.createElement("model-viewer");
      mv.setAttribute("camera-controls", "");
      mv.setAttribute("auto-rotate", "");
      mv.setAttribute("exposure", "1.0");
      mv.setAttribute("shadow-intensity", "0.5");
      mv.setAttribute("bounds", "tight");
      mv.setAttribute("environment-image", "neutral");
      mv.setAttribute("interaction-prompt", "none");
      mv.setAttribute("disable-occlusion", "");  // keep vectors visible
      mv.setAttribute("disable-backfaces", "");  // show interior faces
      mv.style.width = "100%";
      mv.style.height = "100%";
      mv.style.background = "#fff";
      mv.style.borderRadius = "8px";
      return mv;
    }

    async function loadModel(url) {
      const myToken = ++loadToken;

      // present the *exact* URL we're loading (no query)
      linkEl.textContent = url;
      linkEl.href = url;

      // Basic existence check
      setStatus(`Checking ${url} …`);
      try {
        const r = await fetch(url, { method: "GET" });
        if (!r.ok) { setStatus(`HTTP ${r.status} for ${url}`, "err"); return; }
      } catch (e) {
        console.error(e);
        setStatus(`Fetch failed for ${url}`, "err");
        return;
      }

      // Recreate viewer fresh
      host.innerHTML = "";
      const mv = buildViewer();
      host.appendChild(mv);

      // Wire events before setting src
      btnArrows.disabled = true;
      selScalar.disabled = true;
      setStatus(`Loading ${url} …`);

      const finish = (ok, msg) => {
        if (myToken !== loadToken) return; // newer load started; ignore
        btnArrows.disabled = false;
        selScalar.disabled = false;
        setStatus(msg, ok ? "ok" : "err");
      };

      mv.addEventListener("load",  () => finish(true, "Loaded"),                 { once:true });
      mv.addEventListener("error", () => finish(false, "Failed to display model"), { once:true });

      // Small cache-bust to avoid stale decoder state
      mv.src = `${url}?v=${Date.now()}`;
    }

    function update() {
      const files = MODELS[scalar];
      const url = arrows ? files.arrows : files.base;

      title.textContent = files.label;
      legendImg.src = files.legend;
      legendImg.alt = `${files.label} colorbar`;
      legendLabel.textContent = files.label;
      btnArrows.textContent = arrows ? "Hide arrows" : "Show arrows";

      loadModel(url);
    }

    // Events
    selScalar.addEventListener("change", () => { scalar = selScalar.value; arrows = false; update(); });
    btnArrows.addEventListener("click",   () => { arrows = !arrows; update(); });

    // Initial render
    update();
  </script>
</body>
</html>
